#!/usr/bin/env php
<?php

$help = <<< END
usage: drunken --db=<name> --workers-dir=<path> <command>

The most commonly used commands are:
    clear   Delete all completed tasks with 1 month old
    do      Do the work
    help    Print this help
    init    Create mongo collection indexes

END;

date_default_timezone_set('UTC');

function out($message)
{
    printf("drunken: %s\n", $message);
    exit;
}

require_once(__DIR__ . '/../../../autoload.php');

$options = [];
$command = null;
foreach (array_slice($argv, 1) as $param) {
    if (strpos($param, '--') === 0) {
        list($name, $value) = explode('=', substr($param, 2));
        $options[$name] = $value;
    } else {
        $command = $param;
    }
}

$config_path = array_key_exists('config', $options) ? $options['config'] : getcwd() . '/drunken.config.php';
if(is_file($config_path)){
    $config = require($config_path);
} else {
    $config = $options;
}

if (empty($config['db'])) {
    out('Use some database name option --db=<name> or set it in config file');
}
$log_path = !empty($config['log_path']) ? $config['log_path'] : null;
$drunken = new \Drunken\Manager((new MongoClient())->selectDB($config['db']), $log_path);

switch ($command) {
    case 'clear':
        $drunken->clear();
        out('cleared');
        break;
    case 'do':
        if (empty($config['workers-dir'])) {
            out('Set some workers directory --workers-dir=<path> or set it in config file');
        }
        $drunken->setWorkersDir($config['workers-dir']);
        $drunken->doAll();
        out('done');
        break;
    case 'init':
        $drunken->ensureIndexes();
        out('initialized');
        break;
    default:
        echo $help;
}
